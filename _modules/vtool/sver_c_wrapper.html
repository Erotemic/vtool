

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>vtool.sver_c_wrapper &mdash; vtool 1.0.0.dev1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="vtool 1.0.0.dev1 documentation" href="../../index.html"/>
        <link rel="up" title="vtool" href="../vtool.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> vtool</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../vtool.html">vtool package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.chip">vtool.chip module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.clustering">vtool.clustering module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.clustering2">vtool.clustering2 module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.constrained_matching">vtool.constrained_matching module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.coverage_grid">vtool.coverage_grid module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.coverage_kpts">vtool.coverage_kpts module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.distance">vtool.distance module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.ellipse">vtool.ellipse module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.exif">vtool.exif module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.features">vtool.features module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.geometry">vtool.geometry module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.histogram">vtool.histogram module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.image">vtool.image module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.image_filters">vtool.image_filters module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.keypoint">vtool.keypoint module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.linalg">vtool.linalg module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.matching">vtool.matching module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.math">vtool.math module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.nearest_neighbors">vtool.nearest_neighbors module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.other">vtool.other module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.patch">vtool.patch module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.quality_classifier">vtool.quality_classifier module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.segmentation">vtool.segmentation module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.spatial_verification">vtool.spatial_verification module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.sver_c_wrapper">vtool.sver_c_wrapper module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.test_constrained_matching">vtool.test_constrained_matching module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool.trig">vtool.trig module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vtool.html#module-vtool">Module contents</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">vtool</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../vtool.html">vtool</a> &raquo;</li>
      
    <li>vtool.sver_c_wrapper</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for vtool.sver_c_wrapper</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">wraps c implementations slower parts of spatial verification</span>

<span class="sd">CommandLine:</span>
<span class="sd">    python -m vtool.sver_c_wrapper --rebuild-sver</span>
<span class="sd">    python -m vtool.sver_c_wrapper --rebuild-sver --allexamples</span>
<span class="sd">    python -m vtool.sver_c_wrapper --allexamples</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">ctypes</span> <span class="kn">as</span> <span class="nn">C</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="c">#import vtool</span>
<span class="kn">import</span> <span class="nn">vtool.keypoint</span> <span class="kn">as</span> <span class="nn">ktool</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">realpath</span>

<span class="k">print</span><span class="p">,</span> <span class="n">print_</span><span class="p">,</span> <span class="n">printDBG</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[sver_c]&#39;</span><span class="p">)</span>

<span class="n">TAU</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c"># References: tauday.com</span>
<span class="n">c_double_p</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span>

<span class="c"># copied/adapted from _pyhesaff.py</span>
<span class="n">FLAGS_RW</span> <span class="o">=</span> <span class="s">&#39;aligned, c_contiguous, writeable&#39;</span>
<span class="n">kpts_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">FLAGS_RW</span><span class="p">)</span>
<span class="n">fms_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">FLAGS_RW</span><span class="p">)</span>

<span class="n">inliers_t</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ndim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">FLAGS_RW</span><span class="p">)</span>
<span class="n">errs_t</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ndim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">FLAGS_RW</span><span class="p">)</span>
<span class="n">mats_t</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ndim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">FLAGS_RW</span><span class="p">)</span>

<span class="n">dpath</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>

<span class="n">lib_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s">&#39;libsver&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">util_cplat</span><span class="o">.</span><span class="n">get_lib_ext</span><span class="p">())</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--rebuild-sver&#39;</span><span class="p">):</span>  <span class="c"># and __name__ != &#39;__main__&#39;:</span>
        <span class="n">USE_CMAKE</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">USE_CMAKE</span><span class="p">:</span>
            <span class="n">root_dir</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
            <span class="n">repo_dir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">std_build_command</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpp_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s">&#39;sver.cpp&#39;</span><span class="p">)</span>
            <span class="n">cflags</span> <span class="o">=</span> <span class="s">&#39;-shared -fPIC -O2 -ffast-math&#39;</span>
            <span class="n">cmd_fmtstr</span> <span class="o">=</span> <span class="s">&#39;g++ -Wall -Wextra {cpp_fname} -lopencv_core {cflags} -o {lib_fname}&#39;</span>
            <span class="n">cmd_str</span> <span class="o">=</span> <span class="n">cmd_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">)</span>

    <span class="n">c_sver</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">cdll</span><span class="p">[</span><span class="n">lib_fname</span><span class="p">]</span>
    <span class="n">c_getaffineinliers</span> <span class="o">=</span> <span class="n">c_sver</span><span class="p">[</span><span class="s">&#39;get_affine_inliers&#39;</span><span class="p">]</span>
    <span class="n">c_getaffineinliers</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># for every affine hypothesis, for every keypoint pair (is</span>
    <span class="c">#  it an inlier, the error triples, the hypothesis itself)</span>
    <span class="n">c_getaffineinliers</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpts_t</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
                                    <span class="n">kpts_t</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
                                    <span class="n">fms_t</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
                                    <span class="n">C</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span>
                                    <span class="n">inliers_t</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">errs_t</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">mats_t</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="c"># for the best affine hypothesis, for every keypoint pair</span>
    <span class="c">#  (is it an inlier, the error triples (transposed?), the</span>
    <span class="c">#   hypothesis itself)</span>
    <span class="n">c_getbestaffineinliers</span> <span class="o">=</span> <span class="n">c_sver</span><span class="p">[</span><span class="s">&#39;get_best_affine_inliers&#39;</span><span class="p">]</span>
    <span class="n">c_getbestaffineinliers</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span>
    <span class="n">c_getbestaffineinliers</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpts_t</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
                                        <span class="n">kpts_t</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
                                        <span class="n">fms_t</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
                                        <span class="n">C</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span>
                                        <span class="n">inliers_t</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">errs_t</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">mats_t</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>


<div class="viewcode-block" id="get_affine_inliers_cpp"><a class="viewcode-back" href="../../vtool.html#vtool.sver_c_wrapper.get_affine_inliers_cpp">[docs]</a><span class="k">def</span> <span class="nf">get_affine_inliers_cpp</span><span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">xy_thresh_sqrd</span><span class="p">,</span> <span class="n">scale_thresh_sqrd</span><span class="p">,</span> <span class="n">ori_thresh</span><span class="p">):</span>
    <span class="c">#np.ascontiguousarray(kpts1)</span>
    <span class="c">#with ut.Timer(&#39;PreC&#39;):</span>
    <span class="n">num_matches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
    <span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">out_inlier_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_matches</span><span class="p">,</span> <span class="n">num_matches</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">out_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_matches</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">num_matches</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">out_mats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_matches</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c">#with ut.Timer(&#39;C&#39;):</span>
    <span class="n">c_getaffineinliers</span><span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                       <span class="n">kpts2</span><span class="p">,</span> <span class="n">kpts2</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                       <span class="n">fm</span><span class="p">,</span> <span class="n">fm</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                       <span class="n">xy_thresh_sqrd</span><span class="p">,</span> <span class="n">scale_thresh_sqrd</span><span class="p">,</span> <span class="n">ori_thresh</span><span class="p">,</span>
                       <span class="n">out_inlier_flags</span><span class="p">,</span> <span class="n">out_errors</span><span class="p">,</span> <span class="n">out_mats</span><span class="p">)</span>
    <span class="c">#with ut.Timer(&#39;C&#39;):</span>
    <span class="n">out_inliers</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">row</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">out_inlier_flags</span><span class="p">]</span>
    <span class="n">out_errors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">out_errors</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out_inliers</span><span class="p">,</span> <span class="n">out_errors</span><span class="p">,</span> <span class="n">out_mats</span>

</div>
<div class="viewcode-block" id="get_best_affine_inliers_cpp"><a class="viewcode-back" href="../../vtool.html#vtool.sver_c_wrapper.get_best_affine_inliers_cpp">[docs]</a><span class="k">def</span> <span class="nf">get_best_affine_inliers_cpp</span><span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">xy_thresh_sqrd</span><span class="p">,</span>
                                <span class="n">scale_thresh_sqrd</span><span class="p">,</span> <span class="n">ori_thresh</span><span class="p">):</span>
    <span class="c">#np.ascontiguousarray(kpts1)</span>
    <span class="c">#with ut.Timer(&#39;PreC&#39;):</span>
    <span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">out_inlier_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">),),</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">out_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">out_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c">#with ut.Timer(&#39;C&#39;):</span>
    <span class="n">c_getbestaffineinliers</span><span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts1</span><span class="p">),</span>
                           <span class="n">kpts2</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts2</span><span class="p">),</span>
                           <span class="n">fm</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">),</span>
                           <span class="n">xy_thresh_sqrd</span><span class="p">,</span> <span class="n">scale_thresh_sqrd</span><span class="p">,</span> <span class="n">ori_thresh</span><span class="p">,</span>
                           <span class="n">out_inlier_flags</span><span class="p">,</span> <span class="n">out_errors</span><span class="p">,</span> <span class="n">out_mat</span><span class="p">)</span>
    <span class="c">#with ut.Timer(&#39;C&#39;):</span>
    <span class="n">out_inliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out_inlier_flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_errors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out_errors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_inliers</span><span class="p">,</span> <span class="n">out_errors</span><span class="p">,</span> <span class="n">out_mat</span>

</div>
<div class="viewcode-block" id="assert_output_equal"><a class="viewcode-back" href="../../vtool.html#vtool.sver_c_wrapper.assert_output_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_output_equal</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="n">output2</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">1E-8</span><span class="p">,</span> <span class="n">nestpath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lbl1</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">lbl2</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; recursive equality checks &quot;&quot;&quot;</span>
    <span class="c"># Setup</span>
    <span class="k">if</span> <span class="n">nestpath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># record the path through the nested structure as testing goes on</span>
        <span class="n">nestpath</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># print out these variables in all error cases</span>
    <span class="n">common_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;lbl1&#39;</span><span class="p">,</span> <span class="s">&#39;lbl2&#39;</span><span class="p">,</span> <span class="s">&#39;level&#39;</span><span class="p">,</span> <span class="s">&#39;nestpath&#39;</span><span class="p">]</span>
    <span class="c"># CHECK: types</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">output1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">output2</span><span class="p">),</span> <span class="s">&#39;types are not equal&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output1</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output2</span><span class="p">))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;FAILED TYPE CHECKS&#39;</span><span class="p">,</span>
                   <span class="n">keys</span><span class="o">=</span><span class="n">common_keys</span> <span class="o">+</span> <span class="p">[(</span><span class="nb">type</span><span class="p">,</span> <span class="s">&#39;output1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="s">&#39;output2&#39;</span><span class="p">),</span> <span class="p">])</span>
        <span class="k">raise</span>
    <span class="c"># CHECK: length</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="s">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">output2</span><span class="p">),</span> <span class="s">&#39;lens are not equal&#39;</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">common_keys</span> <span class="o">+</span> <span class="p">[(</span><span class="nb">len</span><span class="p">,</span> <span class="s">&#39;output1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="s">&#39;output2&#39;</span><span class="p">),</span> <span class="p">]</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;FAILED LEN CHECKS. &#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="c"># CHECK: ndarrays</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ndarray_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;output1.shape&#39;</span><span class="p">,</span> <span class="s">&#39;output2.shape&#39;</span><span class="p">]</span>
        <span class="c"># CHECK: ndarray shape</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">output1</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">output2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&#39;ndarrays have different shapes&#39;</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">common_keys</span> <span class="o">+</span> <span class="n">ndarray_keys</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;FAILED NUMPY SHAPE CHECKS.&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="c"># CHECK: ndarray equality</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">passed</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">almost_eq</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="n">output2</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">ret_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">passed</span><span class="p">),</span> <span class="s">&#39;ndarrays are unequal.&#39;</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">error_stats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats_str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>  <span class="c"># NOQA</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">common_keys</span> <span class="o">+</span> <span class="n">ndarray_keys</span> <span class="o">+</span> <span class="p">[</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="s">&#39;output1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="s">&#39;output2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;error_stats&#39;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;FAILED NUMPY CHECKS.&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="c"># CHECK: list/tuple items</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="n">output2</span><span class="p">)):</span>
            <span class="c"># recursive call</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">assert_output_equal</span><span class="p">(</span>
                    <span class="n">item1</span><span class="p">,</span> <span class="n">item2</span><span class="p">,</span> <span class="n">lbl1</span><span class="o">=</span><span class="n">lbl2</span><span class="p">,</span> <span class="n">lbl2</span><span class="o">=</span><span class="n">lbl1</span><span class="p">,</span> <span class="n">nestpath</span><span class="o">=</span><span class="n">nestpath</span> <span class="o">+</span> <span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;recursive call failed&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">common_keys</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;item1&#39;</span><span class="p">,</span> <span class="s">&#39;item2&#39;</span><span class="p">,</span> <span class="s">&#39;count&#39;</span><span class="p">])</span>
                <span class="k">raise</span>
    <span class="c"># CHECK: scalars</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">output1</span> <span class="o">==</span> <span class="n">output2</span><span class="p">,</span> <span class="s">&#39;output1 != output2&#39;</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;nestpath= </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nestpath</span><span class="p">,))</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;FAILED SCALAR CHECK.&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">common_keys</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;output1&#39;</span><span class="p">,</span> <span class="s">&#39;output2&#39;</span><span class="p">])</span>
            <span class="k">raise</span>

</div>
<div class="viewcode-block" id="compare_implementations"><a class="viewcode-back" href="../../vtool.html#vtool.sver_c_wrapper.compare_implementations">[docs]</a><span class="k">def</span> <span class="nf">compare_implementations</span><span class="p">(</span><span class="n">func1</span><span class="p">,</span> <span class="n">func2</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">show_output</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lbl1</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">lbl2</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tests two different implementations of the same function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;+ --- BEGIN COMPARE IMPLEMENTATIONS ---&#39;</span><span class="p">)</span>
    <span class="n">func1_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func1</span><span class="p">)</span>
    <span class="n">func2_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;func1_name = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func1_name</span><span class="p">,))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;func2_name = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func2_name</span><span class="p">,))</span>
    <span class="c"># test both versions</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s">&#39;time func1=&#39;</span> <span class="o">+</span> <span class="n">func1_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">t1</span><span class="p">:</span>
        <span class="n">output1</span> <span class="o">=</span> <span class="n">func1</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s">&#39;time func2=&#39;</span> <span class="o">+</span> <span class="n">func2_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>
        <span class="n">output2</span> <span class="o">=</span> <span class="n">func2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t2</span><span class="o">.</span><span class="n">ellapsed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t2</span><span class="o">.</span><span class="n">ellapsed</span> <span class="o">=</span> <span class="mf">1e9</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;speedup = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">ellapsed</span> <span class="o">/</span> <span class="n">t2</span><span class="o">.</span><span class="n">ellapsed</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">assert_output_equal</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="n">output2</span><span class="p">,</span> <span class="n">lbl1</span><span class="o">=</span><span class="n">lbl1</span><span class="p">,</span> <span class="n">lbl2</span><span class="o">=</span><span class="n">lbl2</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;implementations are in agreement :) &#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c"># prints out a nested list corresponding to nested structure</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;IMPLEMENTATIONS DO NOT AGREE&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;func1_name&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;func2_name&#39;</span><span class="p">),</span> <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">depth_profile1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">output1</span><span class="p">)</span>
        <span class="n">depth_profile2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">output2</span><span class="p">)</span>
        <span class="n">type_profile1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_type_profile</span><span class="p">(</span><span class="n">output1</span><span class="p">)</span>
        <span class="n">type_profile2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_type_profile</span><span class="p">(</span><span class="n">output2</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;depth_profile1 = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">depth_profile1</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;depth_profile2 = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">depth_profile2</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;type_profile1 = &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">type_profile1</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;type_profile2 = &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">type_profile2</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;L ___ END COMPARE IMPLEMENTATIONS ___&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output1</span>

    <span class="c">#out_inliers_py, out_errors_py, out_mats_py = py_output</span>
    <span class="c">#out_inliers_c, out_errors_c, out_mats_c = c_output</span>
    <span class="c">#if show_output:</span>
    <span class="c">#    print(&#39;python output:&#39;)</span>
    <span class="c">#    print(out_inliers_py)</span>
    <span class="c">#    print(out_errors_py)</span>
    <span class="c">#    print(out_mats_py)</span>
    <span class="c">#    print(&#39;c output:&#39;)</span>
    <span class="c">#    print(out_inliers_c)</span>
    <span class="c">#    print(out_errors_c)</span>
    <span class="c">#    print(out_mats_c)</span>
    <span class="c">#msg =  &#39;c and python disagree&#39;</span>
    <span class="c">#try:</span>
    <span class="c">#    assert ut.lists_eq(out_inliers_c, out_inliers_py), msg</span>
    <span class="c">#except AssertionError as ex:</span>
    <span class="c">#    ut.printex(ex)</span>
    <span class="c">#    raise</span>
    <span class="c">#try:</span>
    <span class="c">#    passed, error = ut.almost_eq(out_errors_c, out_errors_py, 1E-7, ret_error=True)</span>
    <span class="c">#    assert np.all(passed), msg</span>
    <span class="c">#except AssertionError as ex:</span>
    <span class="c">#    passed_flat = passed.ravel()</span>
    <span class="c">#    error_flat = error.ravel()</span>
    <span class="c">#    failed_indexes = np.where(~passed_flat)[0]</span>
    <span class="c">#    failing_errors = error_flat.take(failed_indexes)</span>
    <span class="c">#    print(failing_errors)</span>
    <span class="c">#    ut.printex(ex)</span>
    <span class="c">#    raise</span>
    <span class="c">#try:</span>
    <span class="c">#    assert np.all(ut.almost_eq(out_mats_c, out_mats_py, 1E-9)), msg</span>
    <span class="c">#except AssertionError as ex:</span>
    <span class="c">#    ut.printex(ex)</span>
    <span class="c">#    raise</span>
    <span class="c">#return out_inliers_c</span>

</div>
<div class="viewcode-block" id="test_calling"><a class="viewcode-back" href="../../vtool.html#vtool.sver_c_wrapper.test_calling">[docs]</a><span class="k">def</span> <span class="nf">test_calling</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to ensure cpp and python agree and that cpp is faster</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.sver_c_wrapper --test-test_calling</span>
<span class="sd">        python -m vtool.sver_c_wrapper --test-test_calling --rebuild-sver</span>
<span class="sd">        python -m vtool.sver_c_wrapper --test-test_calling --show</span>
<span class="sd">        python -m vtool.sver_c_wrapper --test-test_calling --show --dummy</span>
<span class="sd">        python -m vtool.sver_c_wrapper --test-test_calling --show --fname1=easy1.png --fname2=easy2.png</span>
<span class="sd">        python -m vtool.sver_c_wrapper --test-test_calling --show --fname1=easy1.png --fname2=hard3.png</span>
<span class="sd">        python -m vtool.sver_c_wrapper --test-test_calling --show --fname1=carl.jpg --fname2=hard3.png</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.sver_c_wrapper import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; test_calling()</span>

<span class="sd">    Ignore:</span>
<span class="sd">        %timeit call_python_version(*args)</span>
<span class="sd">        %timeit get_affine_inliers_cpp(*args)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool.spatial_verification</span> <span class="kn">as</span> <span class="nn">sver</span>
    <span class="kn">import</span> <span class="nn">vtool.tests.dummy</span> <span class="kn">as</span> <span class="nn">dummy</span>
    <span class="n">xy_thresh_sqrd</span>    <span class="o">=</span> <span class="n">ktool</span><span class="o">.</span><span class="n">KPTS_DTYPE</span><span class="p">(</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">scale_thresh_sqrd</span> <span class="o">=</span> <span class="n">ktool</span><span class="o">.</span><span class="n">KPTS_DTYPE</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">ori_thresh</span>        <span class="o">=</span> <span class="n">ktool</span><span class="o">.</span><span class="n">KPTS_DTYPE</span><span class="p">(</span><span class="n">TAU</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="s">&#39;xy_thresh_sqrd, scale_thresh_sqrd, ori_thresh&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">keys</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">report_errors</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--dummy&#39;</span><span class="p">):</span>
        <span class="n">testtup</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">testdata_dummy_matches</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s">&#39;--fname1&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;easy1.png&#39;</span><span class="p">)</span>
        <span class="n">fname2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s">&#39;--fname2&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;easy2.png&#39;</span><span class="p">)</span>
        <span class="n">testtup</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">testdata_ratio_matches</span><span class="p">(</span><span class="n">fname1</span><span class="p">,</span> <span class="n">fname2</span><span class="p">)</span>

    <span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm_input</span><span class="p">,</span> <span class="n">fs_input</span><span class="p">,</span> <span class="n">rchip1</span><span class="p">,</span> <span class="n">rchip2</span><span class="p">)</span> <span class="o">=</span> <span class="n">testtup</span>

    <span class="c"># pack up call to aff hypothesis</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm_input</span><span class="p">,</span> <span class="n">xy_thresh_sqrd</span><span class="p">,</span> <span class="n">scale_thresh_sqrd</span><span class="p">,</span> <span class="n">ori_thresh</span><span class="p">)</span>

    <span class="n">ex_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[TEST1] &#39;</span><span class="p">):</span>
            <span class="n">inlier_tup</span> <span class="o">=</span> <span class="n">compare_implementations</span><span class="p">(</span>
                <span class="n">sver</span><span class="o">.</span><span class="n">get_affine_inliers</span><span class="p">,</span>
                <span class="n">get_affine_inliers_cpp</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">lbl1</span><span class="o">=</span><span class="s">&#39;py&#39;</span><span class="p">,</span> <span class="n">lbl2</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
            <span class="n">out_inliers</span><span class="p">,</span> <span class="n">out_errors</span><span class="p">,</span> <span class="n">out_mats</span> <span class="o">=</span> <span class="n">inlier_tup</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[TEST2] &#39;</span><span class="p">):</span>
            <span class="n">bestinlier_tup</span> <span class="o">=</span> <span class="n">compare_implementations</span><span class="p">(</span>
                <span class="n">sver</span><span class="o">.</span><span class="n">get_best_affine_inliers</span><span class="p">,</span>
                <span class="n">get_best_affine_inliers_cpp</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">show_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">lbl1</span><span class="o">=</span><span class="s">&#39;py&#39;</span><span class="p">,</span> <span class="n">lbl2</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
            <span class="n">bestinliers</span><span class="p">,</span> <span class="n">besterror</span><span class="p">,</span> <span class="n">bestmat</span> <span class="o">=</span> <span class="n">bestinlier_tup</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ex_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;some tests failed. see previous stdout&#39;</span><span class="p">)</span>

    <span class="c">#num_inliers_list = np.array(map(len, out_inliers_c))</span>
    <span class="c">#best_argx = num_inliers_list.argmax()</span>
    <span class="c">##best_inliers_py = out_inliers_py[best_argx]</span>
    <span class="c">#best_inliers_c = out_inliers_c[best_argx]</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">show_was_requested</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
        <span class="n">fm_output</span> <span class="o">=</span> <span class="n">fm_input</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">bestinliers</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">next_fnum</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">doclf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">docla</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">show_chipmatch2</span><span class="p">(</span><span class="n">rchip1</span><span class="p">,</span> <span class="n">rchip2</span><span class="p">,</span> <span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm_input</span><span class="p">,</span> <span class="n">ell_linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">show_chipmatch2</span><span class="p">(</span><span class="n">rchip1</span><span class="p">,</span> <span class="n">rchip2</span><span class="p">,</span> <span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm_output</span><span class="p">,</span> <span class="n">ell_linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">show_if_requested</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="call_hello"><a class="viewcode-back" href="../../vtool.html#vtool.sver_c_wrapper.call_hello">[docs]</a><span class="k">def</span> <span class="nf">call_hello</span><span class="p">():</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">cdll</span><span class="p">[</span><span class="s">&#39;./sver.so&#39;</span><span class="p">]</span>
    <span class="n">hello</span> <span class="o">=</span> <span class="n">lib</span><span class="p">[</span><span class="s">&#39;hello_world&#39;</span><span class="p">]</span>
    <span class="n">hello</span><span class="p">()</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.sver_c_wrapper</span>
<span class="sd">        python -m vtool.sver_c_wrapper --allexamples</span>
<span class="sd">        python -m vtool.sver_c_wrapper --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Jon Crall.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.dev1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>